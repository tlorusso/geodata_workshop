---
title: "A brief introduction to the sf package"
output: html_notebook
---

## sf : the tidy way of working with spatial data in R

The sf package is the (relatively) new kid on the block when it comes to working with spatial data in R. 

It provides a much more intuitive way and is easier to learn that the sp package. It provides a syntax and data-structures which are coherent with the tidyverse. 


# Plotting a map the old way

After reading in the shapefile you need to fortify it to be able to join the values which should be used to colour the map to it and plot it. Also the 'mapdata' dataset is created with the sole purpouse of generating the map -> it contains a row for every point which composes the polygons and to each point the value for the municipality mapped. 
```{r,message=F}

library(pacman)
pacman::p_load(rgdal)

#read shapefile with rgdal (in past i've regularly used maptools::readShapePoly) this results in a nested datastructure (lists within lists) which is hard to decompose
shape <- readOGR("geodata/Shape_detailliert_SEEN_2016/UP_GEMEINDEN_SEEN_2016_F.shp")

#fortify
shape2 <- fortify(shape, region='BFS')

# Dataset (Motorization and GA-owners)
mfz_ga <-readRDS("mfz_ga.rds")

#merge data with shapefile

mapdata <- merge(shape2, mfz_ga, by.x="id", by.y="bfs",all.x = TRUE, all.y = TRUE)

mapdata <- mapdata[order(mapdata$order),]


# ggplot mapping  # data layer
m0 <- ggplot(data=mapdata) + 
  geom_path(aes(x=long, y=lat, group=group), color='gray') + 
  coord_equal()+ 
  geom_polygon(aes(x=long, y=lat, group=group, fill=Anteil_GA),color = "white")+
  theme_void()+  
  theme(legend.key.size = unit(1,"line"),                                       
  #Grösse Legende
  legend.key.height= unit(0.5,"line"))+
  scale_fill_continuous(name="GA pro 100 EW")+
  labs(title="GA-Dichte im Kanton Zürich",
       subtitle="Anzahl Generalabonnemente pro 100 Einwohner",x="",y="")

m0

```


## Plotting maps the 'tidy' way with the sf-package

```{r}

library(pacman)

pacman::p_load(sp, sf,tidyverse,gghighlight)

#Shapefile (municipalities) - read_sf generates a tidy dataset, each row represents one municipality, the polygons are stored in a single special geo-variable, the 'geometry' column
gemeinden<- read_sf('geodata/Shape_detailliert_SEEN_2016', stringsAsFactors = FALSE)

# Dataset (Motorization and GA-owners)
mfz_ga <-readRDS("mfz_ga.rds")

#join data - the dataset-structure stays the same, just 
gemdata <-gemeinden %>% left_join(mfz_ga, by=c("BFS"="bfs"))

# dataframe with class sf can easily be ploted to get an overview! not so with sp...
plot(gemdata)

#map with ggplot2
sfmap <-ggplot()+
  geom_sf(data=gemdata,aes(fill=Anteil_GA),color = "white")+
  coord_sf(datum = NA)+  
  theme_void()+#Koordinatennetz verbergen
  theme(legend.key.size = unit(1,"line"),                                       
  legend.key.height= unit(0.5,"line"))+
  scale_fill_continuous(name="GA pro 100 EW")+
  labs(title="GA-Dichte im Kanton Zürich",
       subtitle="Anzahl Generalabonnemente pro 100 Einwohner",x="",y="")

sfmap

```

## sf dataframes: just a data.frame with a special geo-variable! It can be used like an ordinary df.
```{r}
library(gghighlight)

gghighlight_point(gemdata, aes(mfzpro100ew,Anteil_GA),Anteil_GA > 7 & mfzpro100ew<600 | 
                    mfzpro100ew>1000|
                    mfzpro100ew<700 & Anteil_GA<3|
                    mfzpro100ew>750 & Anteil_GA>9)+
  geom_point(aes(size=Anzahl_Einw/1000, color=Anteil_HTA))+
 # geom_smooth(method="loess", se=F)+
  theme_stat()+
  scale_size(name="Einwohner")+
  labs(title="Motorisierungsgrad & Generalabonnements pro Gemeinde\n",
       y="Anzahl GA pro 100 Einwohner",x="Motorfahrzeuge pro 1000 Einwohner")

```

## This was just a foretaste...

Imagine we have several shapefiles which we want to plot layer by layer. With the old way we would need to fortify each shapefile...
```{r}

handlungsraum<- read_sf("geodata/handlungsraeume", stringsAsFactors = FALSE) 

bauzonen <- read_sf("geodata/bauzonen", stringsAsFactors = FALSE) 

sfmap+
  geom_sf(data=handlungsraum,fill=NA)+
  geom_sf(data=bauzonen,alpha=0.5)+
  coord_sf(datum = NA)  
  
#CRS CH LV95 -> swiss projection
st_crs(gemeinden)<- "+init=epsg:2056"

#Projektion wgs 84 lat lng
# sbb <- st_transform(sbb,"+init=epsg:4326 +proj=somerc +lat_0=46.95240555555556 +lon_0=7.439583333333333 +k_0=1 +x_0=2600000 +y_0=1200000 +ellps=bessel +units=m +no_defs")

```


## geospatial operations: join etc!
```{r}

```


